<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKoin Tube Mini App</title>
    <!-- 1. MANDATORY: Load the Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- 2. Ad Network SDKs -->
    <!-- RichAds SDK (RichAds - Network C) -->
    <script src="https://richinfo.co/richpartners/telegram/js/tg-ob.js"></script>
    <script>
        // RichAds Initialization (Network C)
        window.TelegramAdsController = new TelegramAdsController();
        window.TelegramAdsController.initialize({
            pubId: "992092",
            appId: "4420",
        });
    </script>
    <!-- Adsgram SDK (Adsgram.ai - Network A) -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <!-- Monetag SDK (Monetag - Network B) -->
    <script src='//libtl.com/sdk.js' data-zone='10143671' data-sdk='show_10143671'></script>
    
    <!-- 3. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Lucide Icons for social sharing -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center p-4">

    <!-- 
      =======================================================================
      CRITICAL FIRESTORE SECURITY RULES!
      =======================================================================
      
      You MUST apply these rules to your Firebase project to fix the
      "FirebaseError: Missing or insufficient permissions" error.
      
      HOW TO APPLY:
      1. Go to your Firebase Console: https://console.firebase.google.com/
      2. Select your project ("kkoin-tube").
      3. Go to "Firestore Database" in the "Build" menu.
      4. Click the "Rules" tab at the top.
      5. Delete all existing text in the editor.
      6. Copy and paste the ENTIRE block of rules below into the editor.
      7. Click "Publish".
      
      --- PASTE THIS INTO YOUR FIRESTORE RULES TAB ---

      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {

          // Rule 1: User's Private Data (kkoin_data/profile)
          // Allows any authenticated user to read/write ONLY to their specific profile document.
          // This protects individual user balances and wallet addresses.
          match /artifacts/{appId}/users/{userId}/kkoin_data/{documentId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
          }

          // Rule 2: Public Referral Events (Public Read, Authenticated Write)
          // Allows any authenticated user to read all referral events (to calculate total referral count)
          // and allows any authenticated user to create a new referral event when they sign up.
          match /artifacts/{appId}/public/data/referral_events/{documentId} {
            allow read: if request.auth != null;
            allow create: if request.auth != null;
          }
        }
      }
      
      --- END OF RULES TO PASTE ---
      
    -->

    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-lg bg-white shadow-xl rounded-xl p-6 space-y-6">

        <!-- Loading & Error Indicator -->
        <div id="status-message" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

        <!-- Header and KKoin Balance -->
        <header class="text-center space-y-1 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-blue-700">KKoin Tube</h1>
            <p class="text-sm text-gray-500">Watch, Earn, Convert.</p>
            <div class="pt-2">
                <p class="text-gray-600 text-sm">Current Points:</p>
                <p id="kkoin-balance" class="text-5xl font-black text-green-600">0</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-between border-b pb-4">
            <button data-page="dashboard" class="nav-btn font-semibold text-sm text-blue-700 border-b-2 border-blue-700 p-2 transition duration-150">Dashboard</button>
            <button data-page="referral" class="nav-btn font-semibold text-sm text-gray-500 hover:text-blue-500 border-b-2 border-transparent p-2 transition duration-150">Referral</button>
            <button data-page="wallet" class="nav-btn font-semibold text-sm text-gray-500 hover:text-blue-500 border-b-2 border-transparent p-2 transition duration-150">Wallet</button>
        </nav>

        <!-- --- DASHBOARD PAGE (Default View) --- -->
        <section id="dashboard-page" class="page-content space-y-4">
            <h2 class="text-xl font-bold text-gray-700">Earn Kkoin</h2>

            <!-- Watch Ad Button & Ad Simulation Area -->
            <div id="ad-watch-container" class="bg-blue-50 p-4 rounded-lg shadow-inner text-center space-y-3">
                <p class="text-blue-700 font-semibold" id="ad-message">Click below to watch an ad.</p>
                <button id="watch-ad-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                    Watch Video Ad (Earn Kkoin)
                </button>
                <p id="ad-cooldown" class="hidden text-sm text-red-500 font-medium"></p>
                <!-- Optional Debug Display -->
                <p id="ad-debug" class="text-xs text-gray-500 hidden mt-2">Points based on: <span id="debug-network"></span> in <span id="debug-location"></span></p>
            </div>
            
            <!-- Ad Slots for Placement (FIX: Added 'hidden' class to hide this from users) -->
            <div class="space-y-4 pt-4 border-t border-gray-200 hidden">
                <p class="text-sm font-semibold text-gray-600">Ad Placement Areas (Hidden from users):</p>
                
                <!-- ADSGRAM AD SLOT -->
                <div id="adsgram-ad-slot" class="p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-xs text-gray-500 hidden">
                    AdsGram Ad Placement
                </div>

                <!-- MONETAG AD SLOT -->
                <div id="monetag-ad-slot" class="p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-xs text-gray-500 hidden">
                    Monetag Ad Placement (Points via Postback)
                </div>
                
                <!-- RICHADS AD SLOT -->
                <div id="richads-ad-slot" class="p-3 border-2 border-dashed border-gray-300 rounded-lg text-center text-xs text-gray-500 hidden">
                    RichAds Ad Placement
                </div>

                <p class="text-xs text-red-500 text-center">NOTE: Actual ad codes must be integrated and fire a success callback for points to be awarded.</p>
            </div>


        </section>

        <!-- --- REFERRAL PAGE --- -->
        <section id="referral-page" class="page-content space-y-4 hidden">
            <h2 class="text-xl font-bold text-purple-700">Invite & Earn</h2>

            <div class="bg-purple-50 p-4 rounded-lg space-y-3 shadow">
                <!-- Referral Stats -->
                <div class="flex justify-around text-center border-b pb-3 mb-3">
                    <div>
                        <p id="referral-count-display" class="text-3xl font-black text-purple-600">0</p>
                        <p class="text-sm text-purple-700">Users Referred</p>
                    </div>
                    <div>
                        <p id="referral-earnings-display" class="text-3xl font-black text-green-600">0</p>
                        <p class="text-sm text-purple-700">Kkoin Earned</p>
                    </div>
                </div>

                <!-- UPDATED POINT VALUE & Enticing Message -->
                <p class="text-sm text-purple-800 font-semibold">
                    Share your unique link and earn **1,000 Kkoin** per sign-up! Help your friends start earning crypto today.
                </p>
                
                <!-- Referral Link Box -->
                <div class="flex items-center space-x-2">
                    <input type="text" id="referral-link" readonly class="flex-grow p-2 text-sm bg-white border border-purple-300 rounded-lg font-mono truncate" value="Loading...">
                    <button id="copy-referral-btn" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg text-sm transition duration-150 flex items-center">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Social Sharing Buttons -->
                <div class="pt-3 border-t">
                    <p class="text-sm font-medium text-purple-700 mb-2">Share on Social Media:</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <button data-platform="telegram" class="social-share-btn bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="send" class="w-4 h-4"></i><span>Telegram</span>
                        </button>
                        <button data-platform="whatsapp" class="social-share-btn bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="message-square" class="w-4 h-4"></i><span>WhatsApp</span>
                        </button>
                        <button data-platform="x" class="social-share-btn bg-black hover:bg-gray-800 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="twitter" class="w-4 h-4"></i><span>X</span>
                        </button>
                        <button data-platform="threads" class="social-share-btn bg-black hover:bg-gray-800 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="message-circle" class="w-4 h-4"></i><span>Threads</span>
                        </button>
                        <button data-platform="facebook" class="social-share-btn bg-blue-700 hover:bg-blue-800 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="facebook" class="w-4 h-4"></i><span>Facebook</span>
                        </button>
                        <button data-platform="reddit" class="social-share-btn bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg text-xs font-bold transition duration-150 flex items-center justify-center space-x-1">
                            <i data-lucide="bookmark" class="w-4 h-4"></i><span>Reddit</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <p id="referrer-info" class="text-xs text-purple-600 hidden text-center">You were referred by: <span id="referrer-id-display"></span></p>

        </section>

        <!-- --- WALLET PAGE (Updated) --- -->
        <section id="wallet-page" class="page-content space-y-4 hidden">
            <h2 class="text-xl font-bold text-green-700">Wallet & Withdrawal</h2>

            <!-- Conversion Info -->
            <div class="bg-green-50 p-4 rounded-lg space-y-2 shadow-inner">
                <p class="text-sm font-medium text-green-800">Your Equivalent Value:</p>
                <p id="usdt-equivalent" class="text-3xl font-black text-green-600">$0.00 USDT</p>
                <p class="text-xs text-green-700">Conversion Rate: 10,000 Kkoin $\approx$ 1 USDT</p>
                <p id="withdrawal-min-info" class="text-xs text-red-500 font-semibold">Minimum Withdrawal: 10 USDT (100,000 Kkoin) and 100 Referrals</p>
            </div>
            
            <!-- NEW: Wallet Address Input Box -->
            <div class="space-y-1 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <label for="usdt-trc20-page" class="block text-sm font-medium text-gray-700">Your TRC20 Wallet Address (USDT)</label>
                <input type="text" id="usdt-trc20-page" placeholder="Enter or update your TRC20 address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                <p id="wallet-address-status" class="text-xs text-gray-500">Address is required for withdrawal and will be saved.</p>
            </div>

            <!-- Withdrawal Action -->
            <div class="pt-4 border-t space-y-4">
                <button id="open-withdrawal-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50" disabled>
                    Need 10 USDT Minimum
                </button>

                <!-- Create Wallet CTA (Updated text) -->
                <div class="bg-yellow-100 p-3 rounded-lg text-center space-y-2">
                    <p class="text-sm font-medium text-yellow-800">Don't have a crypto wallet?</p>
                    <a href="https://t.me/CoinvetoBot?start=3AC81229" target="_blank" class="inline-flex items-center justify-center w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                        Create Crypto Wallet
                    </a>
                </div>
            </div>
        </section>
        
        <p class="text-xs text-gray-400 text-center pt-2 border-t">Your User ID: <span id="user-id-display">Loading...</span></p>

    </div>

    <!-- Modals (Updated) -->

    <!-- Withdrawal Modal (Hidden by default) -->
    <div id="withdrawal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Confirm Withdrawal</h3>
            <form id="withdrawal-form" class="space-y-4">
                <p class="text-sm text-gray-700">You are about to withdraw <span class="font-bold text-green-600">10 USDT</span> by converting <span class="font-bold text-green-600">100,000 Kkoin</span>.</p>
                
                <div class="space-y-1 bg-gray-50 p-3 rounded-lg border">
                    <p class="block text-sm font-medium text-gray-700">Target TRC20 Address:</p>
                    <p id="modal-target-wallet" class="font-mono text-xs text-gray-900 break-all">Loading...</p>
                    <p id="wallet-error" class="text-xs text-red-500 hidden">Invalid data or insufficient points.</p>
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="close-withdrawal-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="submit-withdrawal-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50">Confirm and Withdraw</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ad Watching Modal (Hidden by default) -->
    <div id="ad-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl text-center space-y-4">
            <h3 class="text-2xl font-bold text-gray-800" id="ad-modal-title">Watching Ad...</h3>
            <div class="w-full h-40 bg-gray-300 flex items-center justify-center rounded-lg shadow-inner">
                <!-- This is the actual ad content area -->
                <p id="ad-content" class="text-gray-500 text-sm">Ad from Network <span id="current-ad-network">A</span></p>
                <!-- Place Monetag/RichAds/Adsgram specific ad container here if needed -->
                <!-- Example: <div id="monetag-ad-display"></div> -->
            </div>
            <p id="ad-countdown-text" class="text-xl font-mono text-gray-800">Please wait for the ad to finish.</p>
            <button id="close-ad-modal-btn" class="px-6 py-2 text-sm font-medium text-white bg-gray-500 rounded-lg hover:bg-gray-600 disabled:opacity-50" disabled>
                Close (Ad is Active)
            </button>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level for debugging
        setLogLevel('debug');

        // --- GLOBAL CONFIG & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kkoin-app';
        // USE YOUR CUSTOM FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBIRfyXKD-wOStJe1HQ_90ICCa1loRCLec",
            authDomain: "kkoin-tube.firebaseapp.com",
            projectId: "kkoin-tube",
            storageBucket: "kkoin-tube.firebasestorage.app",
            messagingSenderId: "549641344693",
            appId: "1:549641344693:web:13ad7b7761ee6c900790fc",
            measurementId: "G-R1R2GPT6NZ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let AdsgramController = null; // Controller for Adsgram SDK

        let userData = {
            kkoinPoints: 0,
            walletAddress: '',
            referrerId: null, // Who referred this user
            lastAdWatch: 0,
            totalReferrals: 0, 
            totalReferralEarnings: 0,
            totalAdsWatched: 0,
            hasReceivedInitialBonus: false
        };
        let currentPage = 'dashboard';

        // --- FINANCIAL & PROFIT CONSTANTS ---
        const MIN_CONVERSION_POINTS = 100000; // 10 USDT minimum (10,000 Kkoin = $1 USDT)
        const USD_PER_KKOIN_RATIO = 1 / 10000; // 0.0001 USD per Kkoin
        const TELEGRAM_BOT_USERNAME = "KkoinTubeAppBot"; // Bot username set
        const REFERRAL_BONUS_POINTS = 1000; // 1000 Kkoin per referral to hit 100 referrals for 10 USDT (100k points)
        const REFERRAL_INITIAL_BONUS_POINTS = 500; // Half of the new bonus
        const MIN_REFERRALS_FOR_WITHDRAWAL = 100; // Hard requirement
        const AD_WATCH_COOLDOWN_MS = 30000; // 30 seconds cooldown between ad watches
        const AD_NETWORK_TIMEOUT_MS = 3000; // 3 seconds timeout for an ad network to load
        
        // Use a "sweet message" for sharing, not the minimums
        const SOCIAL_SHARE_MESSAGE = "ðŸš€ Earn crypto effortlessly with KKoin Tube! Watch short videos, earn Kkoin, and withdraw to USDT. Join me now using my unique link and get a bonus start! Don't miss out:";

        // --- PROFIT LOGIC CONSTANTS ---
        const TARGET_PROFIT_MARGIN = 0.55; // 55% margin required on every ad view
        const MIN_POINTS_PER_AD = 50; // Minimum points awarded to keep users engaged
        
        // --- AD NETWORK CONFIGS ---
        const ADSGRAM_BLOCK_IDS = ["int-16929", "task-16930", "16931"]; // Adsgram IDs for rotation
        const MONETAG_CONFIGS = [
            { id: 10143671, format: 'interstitial', type: 'rewarded' }, // Rewarded Interstitial
            { id: 10143671, format: 'pop', type: 'rewarded' },          // Rewarded Popup
            { id: 10143671, format: 'inApp', type: 'non-rewarded', inAppSettings: { frequency: 2, capping: 0.1, interval: 30, timeout: 5, everyPage: false } } // In-app Interstitial (Non-rewarded)
        ];
        
        const AD_NETWORK_CONFIGS = [
            // This order defines the "waterfall"
            { name: 'Adsgram.ai', base_cpm: 3.00, id: 'A', postback: false, loader: loadAdsgram },
            { name: 'Monetag', base_cpm: 1.50, id: 'B', postback: true, loader: loadMonetag },
            { name: 'RichAds', base_cpm: 4.00, id: 'C', postback: false, loader: loadRichAds }
        ];

        const LOCATION_TIERS = [
            { id: 1, name: 'Tier 1 (High CPM)', multiplier: 1.5 },
            { id: 2, name: 'Tier 2 (Medium CPM)', multiplier: 1.0 },
            { id: 3, name: 'Tier 3 (Low CPM)', multiplier: 0.7 }
        ];

        // --- DOM Elements ---
        // (Moved to top of script to prevent race conditions)
        const statusMessageEl = document.getElementById('status-message');
        const balanceEl = document.getElementById('kkoin-balance');
        const navBtns = document.querySelectorAll('.nav-btn');
        const pageContents = document.querySelectorAll('.page-content');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const adCooldownEl = document.getElementById('ad-cooldown');
        const adMessageEl = document.getElementById('ad-message');
        const adDebugEl = document.getElementById('ad-debug');
        const debugNetworkEl = document.getElementById('debug-network');
        const debugLocationEl = document.getElementById('debug-location');
        const adsgramAdSlotEl = document.getElementById('adsgram-ad-slot');
        const monetagAdSlotEl = document.getElementById('monetag-ad-slot');
        const richadsAdSlotEl = document.getElementById('richads-ad-slot');
        const referralLinkEl = document.getElementById('referral-link');
        const copyReferralBtn = document.getElementById('copy-referral-btn');
        const referralCountDisplayEl = document.getElementById('referral-count-display');
        const referralEarningsDisplayEl = document.getElementById('referral-earnings-display');
        const socialShareBtns = document.querySelectorAll('.social-share-btn');
        const referrerInfoEl = document.getElementById('referrer-info');
        const referrerIdDisplayEl = document.getElementById('referrer-id-display');
        const usdtEquivalentEl = document.getElementById('usdt-equivalent');
        const openWithdrawalBtn = document.getElementById('open-withdrawal-btn');
        const usdtTrc20PageInput = document.getElementById('usdt-trc20-page');
        const walletAddressStatusEl = document.getElementById('wallet-address-status');
        const withdrawalMinInfoEl = document.getElementById('withdrawal-min-info');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const withdrawalModal = document.getElementById('withdrawal-modal');
        const closeWithdrawalModalBtn = document.getElementById('close-withdrawal-modal');
        const withdrawalForm = document.getElementById('withdrawal-form');
        const walletErrorEl = document.getElementById('wallet-error');
        const submitWithdrawalBtn = document.getElementById('submit-withdrawal-btn');
        const adModal = document.getElementById('ad-modal');
        const adCountdownTextEl = document.getElementById('ad-countdown-text');
        const currentAdNetworkEl = document.getElementById('current-ad-network');
        const modalTargetWalletEl = document.getElementById('modal-target-wallet');

        // --- FIREBASE PATHS ---
        const getUserDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'kkoin_data', 'profile');
        const getReferralEventsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'referral_events');

        // --- TELEGRAM INIT ---
        function initializeTelegramWebApp() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                const WebApp = window.Telegram.WebApp;
                WebApp.ready();
                WebApp.expand();
                document.body.style.backgroundColor = WebApp.backgroundColor || '#f3f4f6'; 
                WebApp.BackButton.show();
                WebApp.BackButton.onClick(() => { WebApp.close(); });
            } else {
                console.warn("App not running inside Telegram Web App environment.");
            }
        }

        // --- UTILITY FUNCTIONS ---
        function showStatus(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            switch(type) {
                case 'error': statusMessageEl.classList.add('bg-red-100', 'text-red-800'); break;
                case 'success': statusMessageEl.classList.add('bg-green-100', 'text-green-800'); break;
                default: statusMessageEl.classList.add('bg-blue-100', 'text-blue-800'); break;
            }
            const duration = type === 'error' ? 10000 : 5000;
            setTimeout(() => statusMessageEl.classList.add('hidden'), duration);
        }

        // --- AD NETWORK INITIALIZATION ---
        function initAdsgramController() {
             if (typeof window.Adsgram !== 'undefined') {
                AdsgramController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_IDS[0] });
                console.log("Adsgram Controller Initialized.");
             } else {
                console.warn("Adsgram SDK (sad.min.js) not found. Adsgram ads will be skipped.");
             }
        }
        
        function initRichAdsController(uid) {
            if (typeof window.TelegramAdsController !== 'undefined') {
                console.log(`RichAds Controller Initialized with User ID: ${uid}`);
            } else {
                console.warn("RichAds SDK (tg-ob.js) not found. RichAds will be skipped.");
            }
        }

        // --- NAVIGATION/ROUTING ---
        function navigateTo(pageId) {
            currentPage = pageId;
            pageContents.forEach(page => page.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');

            navBtns.forEach(btn => {
                btn.classList.remove('text-blue-700', 'border-blue-700');
                btn.classList.add('text-gray-500', 'border-transparent', 'hover:text-blue-500');
                if (btn.getAttribute('data-page') === pageId) {
                    btn.classList.add('text-blue-700', 'border-blue-700');
                    btn.classList.remove('text-gray-500', 'border-transparent');
                }
            });
            lucide.createIcons();
        }

        // --- FIREBASE SETUP & AUTHENTICATION ---
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = userId;
                        referralLinkEl.value = `https://t.me/${TELEGRAM_BOT_USERNAME}?start=${userId}`;
                        
                        // Initialize Ad Controllers that might need the user ID
                        initAdsgramController(userId); 
                        initRichAdsController(userId);
                        
                        // Setup the data listener
                        setupUserListener(userId); 
                        
                        lucide.createIcons();
                    } else {
                        // FIX: Always sign in anonymously when using custom Firebase config
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showStatus(`Authentication Error: ${error.message}`, 'error');
            }
        }

        // --- CORE DATA LISTENER ---
        function setupUserListener(uid) {
            const userDocRef = getUserDocRef(uid);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const firstLoad = !userData.referrerId; // Check if this is the first snapshot
                    userData = { ...userData, ...docSnap.data() };
                    usdtTrc20PageInput.value = userData.walletAddress || '';
                    updateDashboard();
                    
                    // FIX: Check for referral only *after* user data is loaded
                    if (firstLoad) {
                         checkInitialReferral(uid);
                    }
                } else {
                    // New user, create profile
                    setDoc(userDocRef, {
                        kkoinPoints: 0,
                        walletAddress: '',
                        referrerId: getUrlReferrerId(), // Capture referrerId on creation
                        lastAdWatch: 0,
                        totalAdsWatched: 0,
                        hasReceivedInitialBonus: false
                    }).then(() => {
                        console.log("New user profile created.");
                        updateDashboard();
                        // Also check for referral immediately after profile creation
                        checkInitialReferral(uid);
                    }).catch(err => {
                        console.error("Error creating user profile:", err);
                        showStatus("Failed to create user profile data.", 'error');
                    });
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
                showStatus("Error fetching real-time data.", 'error');
            });
            
            setupReferralCountListener(uid);
        }

        function setupReferralCountListener(uid) {
            const q = query(getReferralEventsRef(), where("referrerId", "==", uid));
            onSnapshot(q, (snapshot) => {
                userData.totalReferrals = snapshot.docs.length;
                userData.totalReferralEarnings = snapshot.docs.length * REFERRAL_BONUS_POINTS;
                referralCountDisplayEl.textContent = userData.totalReferrals.toLocaleString();
                referralEarningsDisplayEl.textContent = userData.totalReferralEarnings.toLocaleString();
                updateDashboard();
            }, (error) => {
                console.error("Error listening to referral events:", error);
            });
        }
        
        // --- REFERRAL LOGIC ---
        function getUrlReferrerId() {
            const urlParams = new URLSearchParams(window.location.search);
            const startappParam = urlParams.get('startapp');
            if (startappParam && startappParam !== userId) {
                return startappParam;
            }
            return null;
        }
        
        async function checkInitialReferral(uid) {
            const urlReferrerId = getUrlReferrerId();
            
            // Only process if a URL referrer exists AND the user's profile doesn't have one set yet.
            if (urlReferrerId && !userData.referrerId) {
                // User was referred, log the event
                await logReferralEvent(urlReferrerId, uid);
                // Update the user's profile to permanently store the referrer
                await updateDoc(getUserDocRef(uid), { referrerId: urlReferrerId })
                     .catch(err => console.error("Could not set new user's referrerId:", err));
                     
            } else if (userData.referrerId) {
                // This user was already referred in the past, just display it
                referrerInfoEl.classList.remove('hidden');
                referrerIdDisplayEl.textContent = userData.referrerId;
            }
        }
        
        async function logReferralEvent(referrerId, referredId) {
            if (referrerId === referredId) return; // Can't refer self

            try {
                // Check if this referral event (for this specific referred user) already exists
                const q = query(getReferralEventsRef(), where("referredId", "==", referredId));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // 1. Create the public referral event
                    await addDoc(getReferralEventsRef(), {
                        referrerId: referrerId,
                        referredId: referredId,
                        timestamp: serverTimestamp(),
                        bonusPoints: REFERRAL_BONUS_POINTS,
                        status: 'claimed'
                    });

                    // 2. Grant bonus to the referrer (transaction for safety)
                    const referrerDocRef = getUserDocRef(referrerId);
                    await runTransaction(db, async (transaction) => {
                        const referrerDoc = await transaction.get(referrerDocRef);
                        if (referrerDoc.exists()) {
                            const newPoints = (referrerDoc.data().kkoinPoints || 0) + REFERRAL_BONUS_POINTS;
                            transaction.update(referrerDocRef, { kkoinPoints: newPoints });
                        }
                    });
                    
                    // 3. Grant initial bonus to the *new* user
                    if (!userData.hasReceivedInitialBonus) {
                        const referredDocRef = getUserDocRef(referredId);
                        await updateDoc(referredDocRef, { 
                            kkoinPoints: (userData.kkoinPoints || 0) + REFERRAL_INITIAL_BONUS_POINTS,
                            hasReceivedInitialBonus: true
                        });
                    }

                    showStatus(`Referral successful! You and user ${referrerId} received a bonus.`, 'success');
                    
                    // Force display of referrer info immediately
                    userData.referrerId = referrerId;
                    referrerInfoEl.classList.remove('hidden');
                    referrerIdDisplayEl.textContent = userData.referrerId;
                }
            } catch (error) {
                console.error("Error processing referral event:", error);
                showStatus("Failed to process referral bonus. Please try again.", 'error');
            }
        }
        
        // --- DASHBOARD/PAGE UPDATES ---
        function updateDashboard() {
            balanceEl.textContent = (userData.kkoinPoints || 0).toLocaleString();
            const usdtValue = ((userData.kkoinPoints || 0) * USD_PER_KKOIN_RATIO).toFixed(2);
            usdtEquivalentEl.textContent = `$${usdtValue} USDT`;
            
            const isReadyForPoints = (userData.kkoinPoints || 0) >= MIN_CONVERSION_POINTS;
            const isReadyForReferrals = (userData.totalReferrals || 0) >= MIN_REFERRALS_FOR_WITHDRAWAL;
            const isReadyForWithdrawal = isReadyForPoints && isReadyForReferrals;
            const walletIsValid = /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(userData.walletAddress || '');

            openWithdrawalBtn.disabled = !isReadyForWithdrawal || !walletIsValid;
            
            if (!isReadyForPoints) {
                openWithdrawalBtn.textContent = `Need $10 USDT Minimum (${MIN_CONVERSION_POINTS.toLocaleString()} Kkoin)`;
            } else if (!isReadyForReferrals) {
                openWithdrawalBtn.textContent = `Need ${MIN_REFERRALS_FOR_WITHDRAWAL} Referrals (${userData.totalReferrals || 0} done)`;
            } else {
                 openWithdrawalBtn.textContent = "Withdraw Earnings";
            }
            
            withdrawalMinInfoEl.textContent = `Minimum Withdrawal: 10 USDT (${MIN_CONVERSION_POINTS.toLocaleString()} Kkoin) and ${MIN_REFERRALS_FOR_WITHDRAWAL} Referrals`;

            if (userData.walletAddress && walletIsValid) {
                walletAddressStatusEl.textContent = "Address is saved and ready for withdrawal.";
                walletAddressStatusEl.classList.remove('text-red-500', 'text-gray-500');
                walletAddressStatusEl.classList.add('text-green-600');
            } else if (userData.walletAddress && !walletIsValid) {
                walletAddressStatusEl.textContent = "Saved address looks invalid. Please correct it.";
                walletAddressStatusEl.classList.remove('text-green-600', 'text-gray-500');
                walletAddressStatusEl.classList.add('text-red-500');
            } else {
                walletAddressStatusEl.textContent = "Address is required for withdrawal and will be saved.";
                walletAddressStatusEl.classList.remove('text-green-600', 'text-red-500');
                walletAddressStatusEl.classList.add('text-gray-500');
            }

            if (userData.referrerId) {
                referrerInfoEl.classList.remove('hidden');
                referrerIdDisplayEl.textContent = userData.referrerId;
            }
            
            updateAdButtonState();
        }

        function updateAdButtonState() {
            if (!watchAdBtn.disabled) { // Only update if not already in an ad-loading state
                const now = Date.now();
                const timeSinceLastWatch = now - (userData.lastAdWatch || 0);

                if (timeSinceLastWatch < AD_WATCH_COOLDOWN_MS) {
                    watchAdBtn.disabled = true;
                    adMessageEl.textContent = "Ad Cooldown Active";
                    adCooldownEl.classList.remove('hidden');
                    
                    const remainingTime = Math.ceil((AD_WATCH_COOLDOWN_MS - timeSinceLastWatch) / 1000);
                    adCooldownEl.textContent = `Next ad in: ${remainingTime}s`;

                    const timeout = setTimeout(() => {
                        watchAdBtn.disabled = false;
                        adMessageEl.textContent = "Click below to watch an ad.";
                        adCooldownEl.classList.add('hidden');
                    }, AD_WATCH_COOLDOWN_MS - timeSinceLastWatch);

                    if (window.adTimeout) clearTimeout(window.adTimeout);
                    window.adTimeout = timeout;
                } else {
                    watchAdBtn.disabled = false;
                    adMessageEl.textContent = "Click below to watch an ad.";
                    adCooldownEl.classList.add('hidden');
                }
            }
        }

        // --- AD WATCHING & PROFIT LOGIC ---
        function simulateUserLocation() {
            const rand = Math.random();
            if (rand < 0.25) return LOCATION_TIERS[0];
            if (rand < 0.65) return LOCATION_TIERS[1];
            return LOCATION_TIERS[2];
        }
        
        function calculateAdPoints(networkConfig) {
            const userLocation = simulateUserLocation();
            const effectiveCPM = networkConfig.base_cpm * userLocation.multiplier;
            const revenuePerAd = effectiveCPM / 1000;
            const maxUserRewardCost = revenuePerAd * (1 - TARGET_PROFIT_MARGIN);
            let calculatedPoints = maxUserRewardCost / USD_PER_KKOIN_RATIO;
            let finalPoints = Math.floor(calculatedPoints);
            finalPoints = Math.max(finalPoints, MIN_POINTS_PER_AD);
            finalPoints += Math.floor(Math.random() * 21) - 10;
            finalPoints = Math.max(finalPoints, MIN_POINTS_PER_AD); 
            return { 
                points: finalPoints, 
                network: networkConfig.name, 
                locationTier: userLocation.name,
                isPostback: networkConfig.postback
            };
        }
        
        function showAdModal(networkName) {
            adModal.classList.remove('hidden');
            adModal.classList.add('flex');
            document.getElementById('ad-modal-title').textContent = `Loading Ad from ${networkName}...`;
            currentAdNetworkEl.textContent = networkName;
            adCountdownTextEl.textContent = "Please wait for the ad to start.";
        }
        
        function hideAdModal(networkName, status) {
            adModal.classList.add('hidden');
            adModal.classList.remove('flex');
            if (status === 'error') {
                showStatus(`Ad from ${networkName} failed to load. Trying next network...`, 'error');
            }
        }
        
        // --- AD NETWORK LOADERS (WATERFALL) ---
        
        /**
         * Creates a promise that resolves on ad success or rejects on failure/timeout.
         */
        function createAdPromise(loaderFunction, adResult) {
            return new Promise((resolve, reject) => {
                // Create a timeout that rejects if the ad takes too long
                const timeout = setTimeout(() => {
                    console.warn(`Ad network ${adResult.network} timed out after ${AD_NETWORK_TIMEOUT_MS}ms.`);
                    reject(new Error('Ad load timeout'));
                }, AD_NETWORK_TIMEOUT_MS);

                // Define success/failure callbacks
                const onSuccess = () => {
                    clearTimeout(timeout); // Ad succeeded, clear the timeout
                    resolve(); // Resolve the promise
                };
                
                const onFailure = (error) => {
                    clearTimeout(timeout); // Ad failed, clear the timeout
                    console.error(`Ad network ${adResult.network} failed:`, error);
                    reject(error); // Reject the promise
                };

                // Call the specific ad network loader
                loaderFunction(adResult, onSuccess, onFailure);
            });
        }
        
        // Loader for Adsgram.ai (Network A)
        function loadAdsgram(adResult, onSuccess, onFailure) {
            if (!AdsgramController) return onFailure(new Error('Adsgram SDK not initialized'));

            const adIndex = (userData.totalAdsWatched || 0) % ADSGRAM_BLOCK_IDS.length;
            const currentBlockId = ADSGRAM_BLOCK_IDS[adIndex];
            
            try {
                 AdsgramController.init({ blockId: currentBlockId }); 
            } catch(e) {
                 return onFailure(new Error(`Adsgram init error: ${e.message}`));
            }
            
            AdsgramController.showRewardedAd()
                .then(onSuccess) // Ad success
                .catch(onFailure); // Ad failure (skipped, error, etc.)
        }
        
        // Loader for Monetag (Network B)
        function loadMonetag(adResult, onSuccess, onFailure) {
            const zoneId = MONETAG_CONFIGS[0].id; 
            const showAdFunction = window[`show_${zoneId}`];
            const currentConfigIndex = (userData.totalAdsWatched || 0) % MONETAG_CONFIGS.length;
            const currentConfig = MONETAG_CONFIGS[currentConfigIndex];

            if (!showAdFunction) return onFailure(new Error('Monetag SDK function not found'));

            let adPromise;
            try {
                if (currentConfig.format === 'interstitial') {
                    adPromise = showAdFunction();
                } else if (currentConfig.format === 'pop') {
                    adPromise = showAdFunction('pop');
                } else if (currentConfig.format === 'inApp') {
                    showAdFunction({ type: 'inApp', inAppSettings: currentConfig.inAppSettings });
                    // This is NON-REWARDED. We resolve immediately but won't credit points.
                    adResult.points = 0; // Ensure no points are awarded
                    return onSuccess(); // Signal success, but adResult.points is 0
                } else {
                    return onFailure(new Error('Unknown Monetag format'));
                }
                
                adPromise
                    .then(() => {
                        if (currentConfig.type !== 'rewarded') adResult.points = 0;
                        onSuccess(); // Ad success
                    })
                    .catch(onFailure); // Ad failure

            } catch (e) {
                onFailure(e);
            }
        }
        
        // Loader for RichAds (Network C)
        function loadRichAds(adResult, onSuccess, onFailure) {
            if (typeof window.TelegramAdsController === 'undefined') {
                return onFailure(new Error('RichAds SDK not initialized'));
            }
            
            // This is a MOCK. In a real app, RichAds SDK would provide its own callbacks.
            // We simulate a 2-second ad view for this mock.
            const MOCK_RICHADS_DURATION = 2000;
            adCountdownTextEl.textContent = `Simulating RichAds view...`;
            
            setTimeout(() => {
                console.log("RichAds mock ad complete.");
                onSuccess(); // Simulate success
            }, MOCK_RICHADS_DURATION);
            
            // In a real app, you would call something like:
            // window.TelegramAdsController.showRewardedAd({
            //     onSuccess: onSuccess,
            //     onFailure: onFailure
            // });
        }

        async function startAdWatchSimulation() {
            if (watchAdBtn.disabled) return;
            watchAdBtn.disabled = true;
            adDebugEl.classList.add('hidden');
            adMessageEl.textContent = "Loading ads, please wait...";

            let adRewarded = false;
            
            // Loop through the ad network waterfall
            for (const networkConfig of AD_NETWORK_CONFIGS) {
                const adResult = calculateAdPoints(networkConfig);
                showAdModal(adResult.network);
                
                try {
                    // Try to load the ad from this network
                    await createAdPromise(networkConfig.loader, adResult);
                    
                    // --- SUCCESS ---
                    // Ad was successful (or non-rewarded Monetag ad played)
                    if (adResult.points > 0) {
                        await finishAdWatch(adResult); // Credit the points
                        adRewarded = true;
                    } else {
                        // Non-rewarded ad played (e.g., Monetag In-App)
                        console.log("Non-rewarded ad shown.");
                        // We still count this as a "success" to apply cooldown
                        await finishAdWatch(adResult); 
                        adRewarded = true; // Mark as success to stop the waterfall
                    }
                    break; // Exit the loop on success
                    
                } catch (error) {
                    // --- FAILURE ---
                    // Ad timed out or failed, try the next network in the waterfall
                    console.warn(`Failed to load from ${networkConfig.name}. Trying next network.`);
                    hideAdModal(networkConfig.name, 'error');
                }
            }

            // --- WATERFALL COMPLETE ---
            if (!adRewarded) {
                // All networks in the waterfall failed
                showStatus("All ad networks are busy. Please try again in a moment.", 'error');
                hideAdModal("All Networks", 'final-error');
            }
            
            // Re-enable the button state (cooldown will be applied if ad was successful)
            updateAdButtonState();
        }


        async function finishAdWatch(adResult) {
            const pointsEarned = adResult.points;
            
            // Hide the modal *after* the promise resolves
            hideAdModal(adResult.network, 'success');

            // Only update database if points were actually earned
            if (pointsEarned > 0) {
                let creditMessage = adResult.network + ' (Direct Credit)';
                if (adResult.isPostback) {
                    creditMessage = adResult.network + ' (Points Pending Server Validation)';
                }

                try {
                    const userDocRef = getUserDocRef(userId);
                    await updateDoc(userDocRef, {
                        kkoinPoints: (userData.kkoinPoints || 0) + pointsEarned,
                        lastAdWatch: Date.now(),
                        totalAdsWatched: (userData.totalAdsWatched || 0) + 1
                    });
                    
                    const statusType = adResult.isPostback ? 'info' : 'success';
                    showStatus(`You earned ${pointsEarned} Kkoin from ${creditMessage}.`, statusType);
                    
                    debugNetworkEl.textContent = adResult.network;
                    debugLocationEl.textContent = adResult.locationTier;
                    adDebugEl.classList.remove('hidden');

                } catch (error) {
                    console.error("Error updating points:", error);
                    showStatus("Failed to record points.", 'error');
                }
            } else {
                // This was a non-rewarded ad, just update the ad count and timestamp
                try {
                     const userDocRef = getUserDocRef(userId);
                     await updateDoc(userDocRef, {
                         lastAdWatch: Date.now(),
                         totalAdsWatched: (userData.totalAdsWatched || 0) + 1
                     });
                     console.log("Non-rewarded ad view logged.");
                } catch (error) {
                     console.error("Error logging non-rewarded ad:", error);
                }
            }
        }

        // --- WITHDRAWAL LOGIC ---
        async function saveWalletAddress(wallet) {
            try {
                const userDocRef = getUserDocRef(userId);
                await updateDoc(userDocRef, { walletAddress: wallet });
                userData.walletAddress = wallet;
                updateDashboard();
            } catch (error) {
                console.error("Error saving wallet address:", error);
            }
        }

        function openWithdrawalModal() {
            const wallet = usdtTrc20PageInput.value.trim();
            const isReadyForPoints = (userData.kkoinPoints || 0) >= MIN_CONVERSION_POINTS;
            const isReadyForReferrals = (userData.totalReferrals || 0) >= MIN_REFERRALS_FOR_WITHDRAWAL;

            if (!isReadyForPoints) {
                showStatus(`You need ${MIN_CONVERSION_POINTS.toLocaleString()} Kkoin (10 USDT) to withdraw.`, 'error');
                return;
            }
            if (!isReadyForReferrals) {
                showStatus(`You must refer ${MIN_REFERRALS_FOR_WITHDRAWAL} users before you can withdraw.`, 'error');
                return;
            }
            if (!/^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(wallet)) {
                showStatus("Please enter a valid TRC20 wallet address before withdrawing.", 'error');
                usdtTrc20PageInput.focus();
                return;
            }
            
            modalTargetWalletEl.textContent = wallet;
            walletErrorEl.classList.add('hidden');
            withdrawalModal.classList.remove('hidden');
            withdrawalModal.classList.add('flex');
        }

        function closeWithdrawalModal() {
            withdrawalModal.classList.add('hidden');
            withdrawalModal.classList.remove('flex');
            walletErrorEl.classList.add('hidden');
        }

        withdrawalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitWithdrawalBtn.disabled = true;
            const wallet = modalTargetWalletEl.textContent;
            
            if ((userData.kkoinPoints || 0) < MIN_CONVERSION_POINTS || (userData.totalReferrals || 0) < MIN_REFERRALS_FOR_WITHDRAWAL || !/^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(wallet)) {
                walletErrorEl.textContent = "Withdrawal failed: Minimum requirements not met.";
                walletErrorEl.classList.remove('hidden');
                submitWithdrawalBtn.disabled = false;
                return;
            }

            try {
                const pointsToDeduct = MIN_CONVERSION_POINTS;
                const userDocRef = getUserDocRef(userId);
                await updateDoc(userDocRef, {
                    kkoinPoints: (userData.kkoinPoints || 0) - pointsToDeduct,
                    walletAddress: wallet
                });
                closeWithdrawalModal();
                showStatus(`Withdrawal request for $10.00 USDT submitted to ${wallet}. Processing may take 24-48 hours.`, 'success');
            } catch (error) {
                console.error("Error during withdrawal:", error);
                showStatus("Withdrawal failed due to a database error.", 'error');
            } finally {
                submitWithdrawalBtn.disabled = false;
            }
        });
        
        // --- SHARING LOGIC ---
        function handleSocialShare(platform) {
            const referralLink = referralLinkEl.value;
            const encodedMessage = encodeURIComponent(`${SOCIAL_SHARE_MESSAGE} ${referralLink}`);
            let url = '';
            switch (platform) {
                case 'telegram': url = `https://t.me/share/url?url=${encodedMessage}`; break;
                case 'whatsapp': url = `whatsapp://send?text=${encodedMessage}`; break;
                case 'x': url = `https://twitter.com/intent/tweet?text=${encodedMessage}`; break;
                case 'threads': url = `https://www.threads.net/intent/post?text=${encodedMessage}`; break;
                case 'facebook': url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}&quote=${encodedMessage}`; break;
                case 'reddit': url = `https://www.reddit.com/submit?url=${encodeURIComponent(referralLink)}&title=${encodeURIComponent("Join KKoin Tube and earn crypto!")}`; break;
                default: return;
            }
            window.open(url, '_blank');
        }

        // --- EVENT LISTENERS ---
        initializeTelegramWebApp(); // Initialize Telegram WebApp immediately
        navBtns.forEach(btn => btn.addEventListener('click', (e) => navigateTo(e.currentTarget.getAttribute('data-page'))));
        watchAdBtn.addEventListener('click', startAdWatchSimulation);
        usdtTrc20PageInput.addEventListener('input', () => {
            const wallet = usdtTrc20PageInput.value.trim();
            if (/^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(wallet)) {
                if (wallet !== userData.walletAddress) saveWalletAddress(wallet);
            } else {
                if (wallet.length > 0) {
                    walletAddressStatusEl.textContent = "Please ensure the format is correct (must start with 'T').";
                    walletAddressStatusEl.classList.remove('text-green-600', 'text-gray-500');
                    walletAddressStatusEl.classList.add('text-red-500');
                } else {
                    walletAddressStatusEl.textContent = "Address is required for withdrawal and will be saved.";
                    walletAddressStatusEl.classList.remove('text-green-600', 'text-red-500');
                    walletAddressStatusEl.classList.add('text-gray-500');
                }
            }
            updateDashboard();
        });
        openWithdrawalBtn.addEventListener('click', openWithdrawalModal);
        closeWithdrawalModalBtn.addEventListener('click', closeWithdrawalModal);
        copyReferralBtn.addEventListener('click', () => {
            try {
                const link = referralLinkEl.value;
                const textArea = document.createElement("textarea");
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus("Referral link copied to clipboard!", 'success');
            } catch (err) {
                showStatus("Failed to copy link.", 'error');
            }
        });
        socialShareBtns.forEach(btn => btn.addEventListener('click', (e) => handleSocialShare(e.currentTarget.getAttribute('data-platform'))));

        // Initialize App on Window Load
        window.onload = initFirebase;
    </script>
</body>
</html>
